<%- include("./partials/head") %>

<body>    
    <div id="ny-guide-1">
        <h1 id="ny-guide">Edit Guide</h1>
        <div id="ny-guide-form">
            <form action="/editGuide/<%= guide._id %>" method="POST" id="guide-form" enctype="multipart/form-data">
                <h3>Tittel</h3>
                <input type="text" name="tittel" value="<%= guide.tittel %>" required autocomplete="off" class="guide-input">
                <h3>Tag</h3>
                <input type="text" name="tag" value="<%= guide.tag %>" required autocomplete="off" class="guide-input">
                <div id="addNewSection">
                    <% guide.overskrift.forEach((heading, index) => { %>
                        <div name="section">
                            <h2>Seksjon</h2>
                            <div>
                                <h3>Overskrift</h3>
                                <input type="text" name="overskrift[]" value="<%= heading %>" required autocomplete="off" class="guide-input">
                            </div>
                            <div>
                                <h3>Beskrivelse</h3>
                                <textarea name="beskrivelse[]" required autocomplete="off" class="guide-beskrivelse"><%= guide.beskrivelse[index] %></textarea>
                            </div>
                            <div>
                                <h3>Bilde</h3>
                                <div id="drop-area">
                                    <form class="my-form">
                                      <p>Upload files by dragging & dropping, or select them</p>
                                      <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)">
                                      <label class="button" for="fileElem">Select some files</label>
                                    </form>
                                    <div id="gallery"></div>
                                </div>
                            </div>
                        </div>                          
                    <% }) %>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-between;">
                    <div class="flex">
                        <button type="submit" id="new-guide-new" alt="Send Inn">
                            <i>S</i>
                            <i>E</i>
                            <i>N</i>
                            <i>D</i>
                            <i>&nbsp;</i>
                            <i>I</i>
                            <i>N</i>
                            <i>N</i>
                        </button>
                    </div>
                </div>
            </form>
            <div id="edit-button">
                <div class="flex">
                    <button onclick="window.history.back();" id="avbryt" alt="Avbryt">
                        <i>A</i>
                        <i>V</i>
                        <i>B</i>
                        <i>R</i>
                        <i>Y</i>
                        <i>T</i>
                </button>
            </div>
            <div class="flex">
                <button onclick="lagNySeksjon()" id="ny-seksjon" alt="NY SEKSJON" id="border" class="ny-seksjon">
                    <i>N</i>
                    <i>Y</i>
                    <i>&nbsp;</i>
                    <i>S</i>
                    <i>E</i>
                    <i>K</i>
                    <i>S</i>
                    <i>J</i>
                    <i>O</i>
                    <i>N</i>
                </button>
            </div>
            <div class="flex">
                <button id="slett" alt="Slett" onclick="deleteGuide(' <%= guide._id %>')">
                    <i>S</i>
                    <i>L</i>
                    <i>E</i>
                    <i>T</i>
                    <i>T</i>
                </button>
            </div>
        </div>
    </a>
        </div>
    </div>
</body>

<script>
  let dropArea = document.getElementById("drop-area");

["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

["dragenter", "dragover"].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.add("highlight"), false);
});

["dragleave", "drop"].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.remove("highlight"), false);
});

dropArea.addEventListener("drop", handleDrop, false);

function handleDrop(e) {
  let dt = e.dataTransfer;
  let files = dt.files;

  handleFiles(files);
}

function handleFiles(files) {
  files = [...files];
  files.forEach(uploadFile);
  files.forEach(previewFile);
}

function previewFile(file) {
  let reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onloadend = function () {
    let img = document.createElement("img");
    img.src = reader.result;
    img.classList.add("uploaded-image");
    document.getElementById("gallery").appendChild(img);
  };
}

function uploadFile(file) {
  let url = "/nyGuide";
  let formData = new FormData();
  formData.append("file", file);

  fetch(url, {
    method: "POST",
    body: formData,
  })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(() => console.error("Upload failed"));
}

function lagNySeksjon() {
    
    let newSection = document.getElementById("addNewSection");
    newSection.insertAdjacentHTML("beforeend",  
    `
    <div name="section">
                <h2>Seksjon</h2>
                <div>
                    <h3>Overskrift</h3>
                    <input type="text" name="overskrift[]" id="" placeholder="Overskrift" required autocomplete="off" class="guide-input">
                </div>
                <div>
                    <h3>Beskrivelse</h3>
                    <textarea name="beskrivelse[]" id="" placeholder="Beskrivelse" required autocomplete="off" class="guide-beskrivelse"></textarea>
                </div>
                <div>
                    <h3>Bilde</h3>
                    <input type="file" name="bilde" accept="image/png image/jpg image/jpeg" class="flex" multiple id="uploadFile"/>
                </div>

    `)
}

async function deleteGuide(id) {
    const response = await fetch(`/deleteGuide/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include'
    });

    if (response.ok) {
        window.location.href =  "/dashboard";
    } else {
        console.error('Failed to delete guide');
    }
}


</script>